CREATE TABLE `user` (
    user_id INT(11) AUTO_INCREMENT PRIMARY KEY,
    fname VARCHAR(255) NOT NULL,
    mname VARCHAR(255),
    lname VARCHAR(255) NOT NULL,
    username VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    photo VARCHAR(110),
    registration_date DATETIME,
    status ENUM('Active', 'Inactive') NOT NULL,
    password_update_date DATETIME
);



CREATE TABLE Chatting (
    message_id INT(11) AUTO_INCREMENT PRIMARY KEY,
    sender_id INT(11) NOT NULL,
    receiver_id INT(11) NOT NULL,
    timestamp DATETIME NOT NULL,
    message TEXT,
    message_status ENUM('send', 'read') NOT NULL
);

ALTER TABLE Chatting
    ADD CONSTRAINT fk_sender_id FOREIGN KEY (sender_id) REFERENCES User(user_id),
    ADD CONSTRAINT fk_receiver_id FOREIGN KEY (receiver_id) REFERENCES User(user_id);

ALTER TABLE `user`
ADD CONSTRAINT `unique_username` UNIQUE (`username`),
ADD CONSTRAINT `unique_email` UNIQUE (`email`);

ALTER TABLE `user`
MODIFY COLUMN `registration_date` DATETIME NOT NULL;

ALTER TABLE `Chatting`
MODIFY COLUMN `message` TEXT NOT NULL;

ALTER TABLE `user`
MODIFY COLUMN `photo` VARCHAR(110) NOT NULL;

ALTER TABLE Chatting MODIFY message BLOB NOT NULL;


CREATE TABLE IF NOT EXISTS otp_table(
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    otp VARCHAR(255) DEFAULT NULL,
    used BOOLEAN NOT NULL,
    expiry_timestamp DATETIME DEFAULT NULL
);

EVENT TO CHECK IF THE OTP IS EXPIRED :-

CREATE EVENT check_expired_otps
ON SCHEDULE EVERY 1 MINUTE
DO
    UPDATE otp_table SET expiry_timestamp= NULL, otp = NULL
    WHERE expiry_timestamp< NOW();

TO RUN THE EVENT  :-
SET GLOBAL event_scheduler = ON;

SHOW EVENTS WHERE Name = 'check_expired_otps';


TRIGGER TO CHECK IF OTP IS USED 

DELIMITER $$

CREATE TRIGGER before_update_otp_table
BEFORE UPDATE ON otp_table
FOR EACH ROW
BEGIN
    IF NEW.used= 1 THEN
        SET NEW.expiry_timestamp= NULL;
        SET NEW.otp = NULL;
    END IF;
END $$

DELIMITER ;